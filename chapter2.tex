%Status: 5 lorems wifi kieg
%----------------------------------------------------------------------------
\chapter{Komponensek és technológiák}
%----------------------------------------------------------------------------

Ezen fejezet azokat a komponenseket, eszközöket és technológiákat mutatja be, amelyek nem kötõdnek egy konkrét eszközhöz, de a rendszer elkészítésében fontos szerepet játszottak.

%----------------------------------------------------------------------------
\section{Vezetéknélküli kommunikáció}
%----------------------------------------------------------------------------

A megtervezett eszközöknél alapvetõ követelmény a vezetéknélküli m\H{u}ködés. A továbbiakban három, IOT rendszerekben használható szabvány kerül bemutatásra. 

%----------------------------------------------------------------------------
\subsection{WiFi és a IEEE 802.11-es szabvány \cite{wiki-wifi} \cite{wiki-ieee802.11}}
%----------------------------------------------------------------------------
A WiFi egy vezetéknélküli adatátviteli technológia, IEEE 802.11 melynek technikai részletei a IEEE 802.11 szabványcsomagban vannak szabályozva. A szabvány elsõ verziója 1997-ben került kiadásra, ami azóta számos alkalommal került bõvítésre. Napjainkban a 802.11n-es verziót (2009) megvalósító készülékek a legelterjedtebbek. Ezen eszközök 2.4GHz és 5GHz frekvenciákon üzemelnek, egy antennával az elérhetõ maximális sebesség 150 Mbit/sec, és jellemzõen 70m beltéri és 250m kültéri hatótávolsággal rendelkeznek. Hasznos kiegészítése a szabványnak a WiFi Ad Hoc Mode (vagy másnéven WiFi Direct), ami két eszköz pont-pont (peer-to-peer) összeköttetését teszi lehetõvé.

\textbf{WEP (Wired Equivalent Privacy)} A szabvány legelsõ verziójától kezdve létezik, de használata ellenjavallott, mivel csak alkalmi próbálkozás ellen véd, egy szakember az adás hosszú távú megfigyelésével könnyedén vissza tudja fejteni a kulcsot.

\textbf{WPA (WiFi Protected Access)} A WEP leváltására jött létre. Egy TKIP nev\H{u} titkosítási algoritmust használ, ami már bizonyos idõközönként új kulcsot generál, védelmet nyújtva a brute force támadások ellen.

A legtöbb háztartásban a WiFi adottságnak tekinthetõ. Az okoseszközök számára a meglévõ hálózat nyújtotta lefedettség, és a WiFi-képes eszközök széles köre optimális választássá teszi annak ellenére, hogy az energiaigénye meglehetõsen magas.  

%----------------------------------------------------------------------------
\subsection{Bluetooth \cite{wiki-bluetooth}}
%----------------------------------------------------------------------------

A szabvány elsõsorban mobil eszközök kis hatótávolságú rádiós kapcsolatához lett kifejlesztve, megszüntetve a kábelek szülségességét. Az adás a 2.4GHz-es frekvenciasávban történik. Az eszközök PAN-ekbe (Personal Area Netowrk) szervezõdnek, egy mester-hez 7 másik készülék tud csatlakozni.

\begin{table}[ht]
	\footnotesize
	\centering
	\caption{Bluetooth osztályok jellemzõ adatai}
	\begin{tabular}{|c|c|c|}
		\hline
		 & \textbf{Energia} & \textbf{Hatótáv} \\ 
		\hline
		\textbf{Class 1} & 100mW & 100m	\\ 
		\hline
		\textbf{Class 2} & 2.5mW & 10m	\\ 
		\hline
		\textbf{Class 3} & 1 & 1m \\ 
		\hline		
	\end{tabular} 
\end{table}

Az felhasználói eszközök szinte kizárólag \textbf{Class 2}-be tartoznak, a \textbf{Class 1}-et csak az iparban használják. A Bluetooth-al szimmentrikus, pont-pont kapcsolatok létesíthetõek, ellentétben a WiFi-vel ami jóval centralizáltabb.

Okosotthonban történõ alkalmazása nem ideális, mivel egy nagyobb családi ház már nem fedhetõ le egy folyamatosan bekapcsolt állapotban lévõ központi egységgel sem, ráadásul a hét eszközös határ is sz\H{u}kös lehet.


%----------------------------------------------------------------------------
\subsection{Zigbee \cite{wiki-zigbee}}
%----------------------------------------------------------------------------

A Zigbee az IEEE 802.15.4 szabványra épülõ kommunikációs protokol, ami alacsony energiájú digitális rádióadással kreál személyi hálózatokat. Az elsõdleges alkalmazási területének az okosotthonokat, IOT rendszereket és orvosi célú adatgyüjtõ szenzorokat szánják. Célja egy olcsóbb és egyszer\H{u}bb alternatíva nyújtása a WiFi-vel és a Bluetooth-al szemben.

Támogatja a mesh (háló) topológiát amelynek segítségével akár 1000m-es hatótávolság is elérhetõ, ideális eszközs\H{u}r\H{u}ség esetén. Fogyasztása hozzávetõlegesen negyede a WiFi hálózaténak, viszont az adatátvitel sebessége jelentõsen alacsonyabb (250 kbit/s).

Bár a technológia igéretes, még nem terjedt el igazán, szoftveres és hardveres támogatottsága alacsony. Zárt rendszer esetén valószínüleg ez a legjobb választás, de nálam az integrálhatóság prioritás volt, ezért a WiFi-s kommunikáció mellett döntöttem.

%MAYBE: extra info

%----------------------------------------------------------------------------
\section{WiFi képes mikrokontroller (ESP8285) \cite{esp8266-ds} \cite{esp8266-sysdesc} \cite{esp8266-techref}}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/esp8285-block-diagram.png}
	\caption{ESP8285 blokk diagramja} 
\end{figure}

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/esp8285.png}
	\caption{ESP8285 chip} 
\end{figure}

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/esp8285-cad.png}
	\caption{ESP8285 chip CAD modellje}
\end{figure}

Az ESP8285 egy WiFi képes mikrokontroller teljes TCP/IP implementációval, kifejezetten IOT (Internet of Things) alkalmzásokhoz szánva. A chip 2016 nyarán került forgalomba, de egy korábbi változat, az ESP8266 már 2014-óta jelen van. Az egyetlen különbség az ESP8285-be integrált 1MB flash memória, ami az esetek többségében feleslegessé tette az ESP8266-nél még szükséges külsõ memóriamodult. Emiatt minden mindkét változat adatlapjai és a leírások is relevánsak.
A chipcsalád az utóbbi idõben nagy népszer\H{u}ségre tett szert, köszönhetõen annak, hogy a gyártó kínai mellett angolul is elérhetõvé tette a dokumentációt, illetve megnyitotta az SDK-t. 

Az ESP8285 modul kis méret\H{u}, ára rendkívül kedvezõ (2\$ körül nagy tételben), és csak minimális kiegészítõ áramkört igényel, és antennaválasztásnál is nagy szabadságot enged a felhasználónak.

A modul magját egy Tensilica LX106 egység képzi, ami egy 80Mhz-en (opcionálisan 160Mhz ig növelhetõ) 32 bites RISC architektúrtájú mikrokontroller. A chip alapértelmezettként AT parancsokkal irányítható, soros portról vagy akár egy másik mikrokontrollerrõl. Komplexebb funkcionalitás implementálására is számtalan lehetõség van. A legfontosabbak:

\begin{itemize}  
	\item GCC alapú toolchain (egy hivatalos gyártó által fenntartott és egy alternatív változat)
	\item NodeMCU (IOT platform, Lua szkriptnyelven programozható)
	\item Arduino C++ platform 
	\item MicroPython (Python szkriptnyelv értelmezõ)
\end{itemize}

Az egység a tervezés szempontjából legfontosabb tulajdonságai, támogatott protokollok és technológiák: 

\begin{itemize} 
	\item 802.11 b/g/n/e/i támogatás
	\item Wifi Direct (P2P)
	\item Titkosítási szabványok hardveres gyorsítása
	\item+20 dBm adás
	\item-91 dbm vétel
	\item Perifériák: UART, SDIO, SPI, I2C, I2S, IR Remote Control, GPIO, ADC, PWM
	\item M\H{u}ködési feszültség: 3.0 V - 3.6 V
	\item Tokozás: QFN32-pin (5 mm x 5 mm)
	\item Hálózati protokollok: IPv4, TCP, UDP, HTTP, FTP	
\end{itemize}

A Wifi-s kommunikáció egyik gyenge pontja az energiafogyasztás. A jelsugárzás nagy áramfelvétellel jár együtt, illetve az átlagfogyasztás is viszonylag magas. Ezen hátrány kiküszöbölésére, ha az alkalmazási mód lehetõvé teszi, a chip támogat több energiakímélõ m\H{u}ködési módot. A jellemzõ fogyasztási adatok:

\begin{table}[ht]
	\footnotesize
	\centering
	\caption{ESP8285 fogyasztási adatai}
	\begin{tabular}{l r}
		Mód & Fogyasztás \\
		\hline
		Tx 802.11n (adás) & 170 mA\\

		Rx 802.11n (vétel) & 56 mA\\

		Modem-Sleep & 15 mA\\
		
		Light-Sleep & 0.9 mA\\
		
		Deep-Sleep & 10 $\mu A$\\
		
		Kikapcsolva & 0.5 $\mu A$\\
	\end{tabular} 
\end{table}

%----------------------------------------------------------------------------
\subsection{Antenna}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/antennas.png}
	\caption{Antenna megoldások: Meander (A), Invertált F (B), Chip (C)}
\end{figure}

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/antenna.png}
	\caption{Az illesztett antenna}
\end{figure}

A modulnak szüksége van külsõ antennára a WiFi kommunikációhoz (2.4GHz). A legegyszer\H{u}bb és legolcsóbb megoldás a nyomtatott áramkörön elhelyezett antenna. Az antennát 50 $\Omega$ impedanciához kell illeszteni. A leggyakoribb kialakítások a \textbf{meander antenna} és az \textbf{inverted-F antenna}.
Az elõbbi helyigénye hozzávetõlegesen 1.5 cm az utóbbié 3 cm. Az adás minõsége jobb az inverted-F kialakítással, és mivel a hely nekem rendelkezésre állt, e mellett döntöttem. Így illesztésre nem volt szükség, de mivel nyitva akartam hagyni más antennák kipróbálásának a lehetõségét is, ezért az áramkörön elhelyezhetõ két illesztõ induktivitás.

Az antenna eszköz karakterisztikájával kapcsolatban precíz méréseket nem végeztem, de a WiFi kapcsolat akár 20-30 méter távolságból és falon keresztül is stabil maradt.

%----------------------------------------------------------------------------
\subsection{Kötelezõ kiegészítõ elemek}
%----------------------------------------------------------------------------

Az IC elõállít magának egy referenciaáramot, amihez szüksége van egy nagy pontosságú 12k$\Omega$-os ellenállásra. A tápfeszültség sz\H{u}résére egy 100nF-os, 1$\mu$F-os és 10$\mu$F-os kerámiakondenzátor hármast használok, az ajánlásnak megfelelõen.

Az mikrokontroller külsõ rezonátor meglétét igényli. A támogatott frekvenciák 24MHz-tõl 40Mhz-ig terjednek. Mivel a WiFi-s kommunikációnál nem lehet jelentõs frekvenciahiba, vélhetõen a rezonátor pontatlanságára alacsony a tolerancia. A nyomtatott áramkörön érdemes a rezonátorkristályt minél közelebb helyezni a mikrokontrollerhez, viák használata ellenjavallott. Mindhárom eszköznél egy Epson FA-128 26MHz-s kristályt használtam.

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/resonator.png}
	\caption{A rezonátoráramkör}
\end{figure}

%----------------------------------------------------------------------------
\section{Tápellátás}
%----------------------------------------------------------------------------

A tervezési feladat része volt minden egyes eszközhöz az optimális tápellátási módot kiválasztani. A központi egység és a programozható
fali aljzat hálózati áramról m\H{u}küdik, míg a környezeti szenzor és a nyitásérzékelõ hordozható energiaellátást igényel.

(A hálózati feszültségrõl való táplálásról majd késõbb írok. Elõzetesen mindenképp izolált megoldást szeretnék alkalmazni, mint pl. a Flyback converter.)

Az elsõ és legkézenfekvõbb megoldás a mobil eszközökben rendkívül elterjedt Li-ion akkumulátor. Energia és teljesítménys\H{u}r\H{u}ségben is kiváló, nem mérgezõ, és nem rendelkezik memóriaeffektussal. Töltöttségét rendkívül lassan veszíti el. Még kimerült állapotban is képes 3V feszültséget szolgáltatni, ami azt jelenti, hogy 3-3.6V t\H{u}rés\H{u} áramkörökkel az akkumulátor teljes kapacitását ki tudom használni, és elegendõ egy cella. Mivel töltés után a cellafeszültség elérheti a 4.2V-ot, ezért az áramkör mindenképp védelemre szorul. A Li-ion alapú megoldások rendelkeznek hátrányokkal is. Túltöltés és mélykisülés ellen védõáramkört kell alkalmazni. Ennek hiányában a megoldás t\H{u}zveszélyes. Az akkumulátor cella rendkívül sérülékeny, ezért szükség van a fizikai védelemre. Hátrányként említhetõ még a Li-ion cella öregedése is, de a legtöbb esetben, mire a teljesítménycsökkenés relevánsá válik, maga a készülég is elavul. Ha mégis hosszú távú üzemre terveznénk, gondolni kell az akkumulátor cserélhetõségére.

Alternatíva lehet három darab 1.5V-os ceruzaelem használata is, de mivel ez esetben, ha nem akarok elfogadhatatlanul rossz hatásfokot, valamilyen kapcsolóüzem\H{u} tápegységet kell használnom, jelentõs méret\H{u} kiegészítõ áramkörrel. Rádiófrekvenciás alkalmazásoknál jelentõsége van a tápellátás zajmentességének is. Mivel a három elem mérete meghaladja azt a áramkör méretet amit alkalmazni szeretnék, ezért ezt a megoldást elvetendõnek gondolom.

Kis mérete miatt felmerühet egy nem újratölthetõ Li-ion gombelem alkalmazása is, elsõdlegesen akkor, amikor fontos a kis méret és súly, valamint a készülék csak ritkán, rövid idõtartamokra van bekapcsolva. Mivel a WiFi adó áramfelvétele rövidebb idõszakokban meghaladja a gombelem által biztosított maximumot, ezért szükség van egy további kondenzátor elhelyezésére is, ami viszont nagyban semlegesíti ezen megoldás eredeti elõnyeit.

%----------------------------------------------------------------------------
\section{Az mikrokontroller felprogramozása}
%----------------------------------------------------------------------------

Az mikrokontroller UART (Universal Asynchronous Receiver/Transmitter) protokollon keresztül programozható. A programozás és bootolás üzemmód közötti választás a GPIO0 földre illetve tápra húzásával érhetõ el. Alapvetõen két életképes megoldást tudtam elképzelni:

\begin{itemize} 
	\item Az eszközöm integrálva tartalmazza az USB/UART átalakítót, és a GPIO0 értékét egy jumperrel lehet állítani. A számítógépre csatlakozás egy micro USB porton keresztül oldom meg. Az USB/UART konverzió feladatára népszer\H{u} megoldás az FTDI FT230X chip, legfõképpen apró mérete és alacsony ára miatt. 
	\item A szükséges lábakat (GND, 3.3V, RX, TX, GPIO0) egy tüskessorra kivezetem, majd minimális kiegészítõ áramkörrel és egy FTDI UMFT234XD USB portra kapcsolható fejlesztõkártyával programozom az eszközt.
\end{itemize}

Mindhárom eszköz esetén az utóbbi megoldást alkalmaztam. A program feltöltésének protokoljába mélyebben nem tekintettem bele, mivel rendelkezésre álltak kész megoldások (például az esptool.py szkript).

Nem kevés problámát okozott, hogy az alapértelmezett UART baud rate attól függ hogy milyen frekvenciájú rezonátor kerül felhasználásra. A felhasználói programban természetesen állítható a frekvencia, de a bootoláskor kiadott státuszjel, és felprogramozás sebessége is fix. Az a fix frekvencia oszcilloszkóppal megmérve 74880 Hz volt, ami nem egy szabványos érték (40 MHz-es oszcillátor esetén lenne 115200).

%----------------------------------------------------------------------------
\section{A nyomtatott áramkörök}
%----------------------------------------------------------------------------

%----------------------------------------------------------------------------
\subsection{Alkatrészek kiválasztása}
%----------------------------------------------------------------------------

Az alkatrészek kiválasztásánál elsõdleges szempont volt, hogy a lehetõ legkorszer\H{u}bb technikával dolgozzak. Az ellenállásoknál, kondenzátoroknál a 0603-as méretet preferáltam, mivel az még kézzel forrasztható, de egyúttal nagy s\H{u}r\H{u}ségben helyezhetõ el az áramkörön. A rendelésnél az elsõdleges forrásom a Mouser webáruzház volt. A hatalmas válszték mellett az alkatrészek tulajdonságok szerint is jól kereshetõek voltak. A tervezés során tanulmányoztam hasonló eszközöket, illetve hobbistáknak szóló leírásokat is. Azon termékek amelyekrõl ilyen módon többletinformáció állt a rendelkezésemre, természetesen elõnyt élveztek. Az adatlapokban megadott kiegészítõ áramkörre vonatkozó ajánlásokat minden esetben betartottam. 

%----------------------------------------------------------------------------
\subsection{Tervezés}
%----------------------------------------------------------------------------

A kapcsolási rajzot, és a nyomtattott áramkör terveket egyaránt az Altium Designer tervezõszoftverrel készítettem el. Az alkalmazás az egyik legelterjedtebb, és legtöbb funkcióval rendelkezõ csomag a piacon, ezért a szerzett tapasztalatok késõbb rendkívül hasznosak lehetnek. A szoftver tanulmányi célokra ingyenesen elérhetõ volt. A nyáktervezés menete:

\begin{enumerate}  
	\item \textbf{A kapcsolási rajz (Schematic) elkészítése:} Az alkatrészeket szimbólumok reprezentálják. Ezen a tervezési szinten az összeköttetések létrehozása történik meg. 
	\item \textbf{Szimuláció (opcionális):} Ha a komponensekhez készültek m\H{u}ködési modellek, akkor az elkészült kapcsolás viselkedése szimulálható. 
	\item \textbf{A nyomtatott áramkör elkészítése:} Itt történik a board alakjának definiálása, az alkatrészek és huzalozás elhelyezése. A helyesség ellenõrzése tervezési szabályok (Design Rules) segítségével történik.
	\item \textbf{A gyártáshoz szükséges file-ok elõállítása:} Ezutén exportálásra kerülnek a gyártáshoz szükséges leírófileok. A Gerber file-ok tartalmazzák az egyes rétegekre (huzalozás, forrasztásgátlás) vonatkozó információkat. A drill file definiálja a furatok bevágások helyét.
\end{enumerate}

%----------------------------------------------------------------------------
\subsection{Gyártás}
%----------------------------------------------------------------------------

Az elkészült nyáklaptervek az Elektronikai Technológiai Tanszék laborjában kerültek legyártásra. Két huzalozási rétegnél többre nem volt szükség. Az elõírt 0.25mm-es szigetelési közt pár helyen, kis mértékben meg kellett szegnem. A viákhoz 0.5mm-es furatrokat alkalmaztam. 




\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/pcb-layers.png}
	\caption{A nyomtatott áramkör felépítése} 
\end{figure}











