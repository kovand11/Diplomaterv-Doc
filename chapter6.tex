%Status: once read, office grammar checked
%Todo:
%----------------------------------------------------------------------------
\chapter{Környezeti szenzor}
%----------------------------------------------------------------------------

A levegõ tulajdonságainak, illetve a környezeti fénynek a monitorozása számtalan épület automatizálási feladatnál létfontosságú követelmény. A gy\H{u}jtött adatok alapján f\H{u}tés vezérelhetõ, párásító berendezéssel elkerülhetõ a levegõ kiszáradása, illetve a fényviszonyoknak megfelelõen állítható a világitás, bárminem\H{u} emberi beavatkozás nélkül. A vezetéknélküli kivitelezés az installáció során elõnyös, a leolvasások ritkításával a fogyasztás kordában tartható. A mért jellemzõk általában lassan változnak, az eszköz rövid idõre történõ kiesése tolerálható.

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/enviromental-sensor_2d-full.png}
	\caption{A környezeti szenzor nyákterve} 
\end{figure}

%----------------------------------------------------------------------------
\section{Specifikáció}
%----------------------------------------------------------------------------
Ezen eszköz egy általános környezeti szenzort valósít meg. A mérhetõ jellemzõk:

\begin{itemize}  
	\item Hõmérséklet (Bosch BME280)
	\item Nyomás (Bosch BME280)
	\item Páratartalom (Bosch BME280)
	\item Környezeti fény: piros, zöld, kék és fehér csatornával (Vishay VEML6040)
	\item UV/A és UV/B érzékelõ (Vishay VEML6075)
\end{itemize}

A gy\H{u}jtött adatok ember számára is releváns információt biztosítanak, illetve automatizálási algoritmusok bemenetét is képezheti. Az eszköz képes egy kék és egy borostyán LED felvillantásával eseményt jelezni.  

A szenzor mérete 31mm x 50mm, a megvalósítás egy kétréteg\H{u} nyomtatott áramkörön történt, magában foglalva a tápellátást és az WiFi antennát is.
A maximális mobilitást elérendõ, a készüléket egy 1200mAH-ás Li-Po akkumulátorról táplálom, melynek mérete szinte pontosan megegyezik az áramkörével.
Mivel ez az egység került elsõként legyártásra, és a kommunikáció megvalósítása nagyban hasonlított a továbbiakban elkészítendõ részegységekhez, emiatt az alap funkciókon kívül, egyfajta fejlesztõi kártyaként is szolgált. A programozáshoz feltétlenül szükséges és a nem felhasznált lábakat (2 db GPIO és egy 5.7 V toleráns ADC, amely alkalmas lehet az akkumulátor töltöttségi szintjének meghatározására) egyaránt egy tüskesorra vezettem ki.

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/enviromental-sensor-blocks.png}
	\caption{A környezeti szenzor felépítése} 
\end{figure}

A készüléken egy szoftveres webszerver fut. A szolgáltatott adatok közvetlenül, akár a központi egység megléte nélkül is elérhetõek, alapvetõen kétféle módon:
\begin{itemize}  
	\item Ember számára könnyen áttekinthetõ HTML weboldal, amely automatikusan frissül, kiegészítve pár, a fejlesztés során hasznos információt biztosító oldallal
	\item JSON interface, amely biztosítja az egyszer\H{u} kiolvasást más eszközök számára
\end{itemize}

A hardver továbbá fel lett készítve arra, hogy az mélyalvásba legyen helyezhetõ, amelybõl egy belsõ számláló által elõállított reset impulzus segítségével tud felébredni.

%----------------------------------------------------------------------------
\section{Hardver}
%----------------------------------------------------------------------------

Az alkatrészek kiválasztásánál igyekeztem a legkorszer\H{u}bb megoldásokat használni, figyelve arra hogy az alapanyagköltség ne szálljon el. Ezzel néha ellentétes követelmény volt a könny\H{u} összeszerelhetõség, forraszthatóság és mérhetõség.

\begin{table}[ht]
	\footnotesize
	\centering
	\caption{A környezeti szenzor alkatrész listája}
	\begin{tabular}{|c|c|c|c|c|c|}
		\hline
		& \textbf{Db.} 	& \textbf{Leírás} 	& \textbf{Felh.} 	& \textbf{Gyártó} 	& \textbf{Azonosító} \\ 
		\hline
		1 & 1 & WiFi-s mikrokontroller & U1 & Espressif & ESP8285 \\
		\hline
		2 & 1 & Rezonátor kristály & U2 & Epson & FA-128 26Mhz \\
		\hline
		3 & 1 & Feszültség szabályzó & U4 & Microchip & MIC5353 \\
		\hline
		4 & 1 & Levegõ szenzor & U3 & Bosch & BME280 \\
		\hline
		5 & 1 & UVA/B szenzor & U5 & Vishay & VEML6075 \\
		\hline  
		6 & 1 & RGBW szenzor & U6 & Vishay & VEML6040 \\
		\hline  
		7 & 1 & Header & P1 & Omron & XG8V-0831 \\ 
		\hline 
		8 & 1 & Akku csatlakozó & J1 & Adafruit  & JST-PH 2-pin \\ 
		\hline 
		9 & 1 & Nyomógomb & SW1 & Omron & PTS810 \\
		\hline
		10 & 1 & Shottky dióda & D3 & ST & TMMBAT42 \\
		\hline
		11 & 2 & LED (0603) & D1,D2 & Panasonic & LNJxxx \\
		\hline
		12 & 14 & Ellenállás (0603) & R1..14 & Viking Tech Corp. & - \\
		\hline
		13 & 14 & Kondenzátor (0603) & C1..14 & Yageo, Samsung & - \\
		\hline
	\end{tabular} 
\end{table}

%----------------------------------------------------------------------------
\subsection{Tápellátás}
%----------------------------------------------------------------------------

Az eszköz Li-Ion akkumulátorról m\H{u}ködik, hasonlóan a nyitásérzékelõ szenzorhoz, amely a \ref{sec:li-ion-supp} pontban került bõvebben kifejtésre.

%----------------------------------------------------------------------------
\subsection{Szenzorok}
%----------------------------------------------------------------------------
%----------------------------------------------------------------------------
\subsubsection{VEML6040 \cite{veml6040-ds}}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/veml6040-blockdiagram.png}
	\caption{A VEML6040 blokkdiagramja} 
\end{figure}

A VEML6040 egy színérzékeny fotoszenzor. Négy csatornát mér (piros, zöld, kék, és fehér), melyeknek átvitele az emberi szeméhez hasonló.
Lehetséges alkalmazása a szenzornak egy adott spektrumú fény nagy pontosságú elõállítása visszacsatolt struktúrában. Jellemzõ adatok:

\begin{itemize}  
	\item I2C interface
	\item 16 bites csatornafelbontás
	\item 0.007865 lux/digit érzékenység
	\item m\H{u}ködési tartomány  2.5 V - 3.6 V 
\end{itemize}

%----------------------------------------------------------------------------
\subsubsection{VEML6075 \cite{veml6075-ds}}
%----------------------------------------------------------------------------

A VEML6075 egy UVA és UVB tartományban érzékeny fotodiódát tartalmazó integrált chip. A footprint-je illetve a kommunikációs protokolja teljesen megegyezik a VEML6040-es változattal. Olyannyira, hogy ugyanazzal az I2C slave címmel rendelkezik, emiatt egy idõben a két szenzor nem használható.

%----------------------------------------------------------------------------
\subsubsection{BME280 \cite{bme280-ds}}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/bme280-blockdiagram.png}
	\caption{A Bosch BME280 blokkdiagramja} 
\end{figure}

A BME280 integrált chip egy kombinált hõmérséklet, légnyomás és páratratalom szenzor, elsõsorban akkumulátorról m\H{u}ködtetett mobil és viselhetõ eszközökhöz fejlesztve. A páratratalom szenzor akár alkalmas lehet bõrfelülettel való érintkezés detektálására, és a nyomásszenzor akkora felbontással rendelkezik, hogy az eszköz vertikális elmozdulása is mérhetõ vele. A szenzor mindössze 2.5mm x 2.5mm méret\H{u}, készenléti állapotban csupán 0.2 uA-t vesz fel, és I2C valamint SPI interface-en képes kommunikálni.

A m\H{u}ködés lehet normal (periódikusan elvégzett mérés, bármikor kiolvasható) és forced (csak igény esetén mér) üzemmódú, amibõl én az utóbbit használtam. Érdemes minden mért jellemzõt egy idõben kiolvasni, mivel a hõmérséklet hibakompenzálásához szükség van a páratartalom és a nyomás értékekre is.

%----------------------------------------------------------------------------
\section{Szofver}
%----------------------------------------------------------------------------

Az implementációhoz az Arduino által fejlesztett keretrendszert használtam fel. C++11 nyelven magas szinten, mindössze pár sor kóddal már m\H{u}ködõképes webszervert lehet létrehozni. Ha az alapértelmezett paraméterek és mechanizmusok nem megfelelõek, akkor persze jelentõsen nõ a kódkomplexitás. Fontos volt figyelni arra, hogy esetenként az én ESP8285-öm lábkiosztása nem egyezik meg az Arduino által gyártott fejlesztõi kártyával (amihez a könyvtár készült), így azt felül kell definiálni. 

Jelenleg a szenzor által biztosított interface teljes egészében HTTP alapú. Az biztosított oldalstruktúra: 
\begin{itemize}  
	\item / (root): Alapértelmezettként bejövõ oldal, (\ref{sensor-webpage}-es ábra)
	\item /info: Eszközinformáció JSON formátumban
	\item /json: Paraméterek (fõként mért adatok) JSON formátumban
	\item /settings: Hová csatlakozzon automatikusan (felhasználó/jelszó)
	\item /status: Azonosító, MAC cím, detektált periférák, futásidej\H{u} memória mennyisége, és firmware információ érhetõ el
	\item /control: Az eszköz paraméterei írhatóak ezen az oldalon kereszt\H{u}l
\end{itemize}


\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/sensor-webpage.png}
	\caption{A környezeti szenzor által szolgáltatott weboldal}
	\label{sensor-webpage}
\end{figure}

A fõoldal 5 másodpercenként frissíti az adatokat, a szervertõl való ismételt lekérdezéssel. Jelenleg a mérések is az oldal lekérdezésének hatására végzõdnek el, maximalizálva az adatok frissességét, de kis mérték\H{u} késleltetést okozva a felhasználónak.

%----------------------------------------------------------------------------
\subsection{Paraméteres interface}
%----------------------------------------------------------------------------

Az egységes programozói interface felé a következõ paraméterek érhetõek el, a \ref{sec:parameters} pontban leírt módon.

\begin{table}[ht]
	\footnotesize
	\centering
	\caption{A Programozható aljzat paraméterei}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\textbf{Név} & \textbf{Hozzáférés} 	& \textbf{Típus} & \textbf{Leírás}  \\ 
		\hline
		ledblue & írható/olvasható & boolean & a kék led állapota \\
		\hline
		ledamber & írható/olvasható & boolean & a borostyán led állapota \\
		\hline
		temperature & olvasható & float & hõmérséklet (C) \\
		\hline
		pressure & olvasható & float & légnyomás (hPa) \\
		\hline
		humidity & olvasható & float & páratartalom (\%)\\
		\hline
		ambient & olvasható & float & környezeti fény (lux) \\
		\hline
		red & olvasható & float & piros komponens számláló \\
		\hline
		green & olvasható & float & zöld komponens számláló \\
		\hline
		blue & olvasható & float & kék komponens számláló \\
		\hline
		white & olvasható & float & fehér komponens számláló \\
		\hline		
	\end{tabular} 
\end{table}

%----------------------------------------------------------------------------
\subsection{HTML oldal létrehozása}
%----------------------------------------------------------------------------

A szoftver legnagyobb része a HTML oldalak létrehozásért felelõs. Érdemes kihasználni a procedurális programozás elõnyeit, és lehetõleg ismétlõdõ mintákból felépíteni a weboldalakat. Példaként bemutatom a \ref{sensor-webpage}-es ábrán látható oldal létrehozásának menetét. Segédfüggvény, ami egy sor (tetszõleges kép és szöveg pár) HTML kódjának létrehozásáért felel:
\lstinputlisting[language=C++]{source/createIconTextLine.txt}
A mért adatokat paraméterként megkapó és a végleges oldalt elõállító kód: 
\lstinputlisting[language=C++]{source/createMainPage.txt}
A képeket, mivel a mikrokontroller nem rendelkezik filerendszerrel, a HTML forráskódjába belekódolva küldöm át (Base64 kódolás). A memória sz\H{u}kössége miatt 32x32 felbontású ikonokat használtam.

%----------------------------------------------------------------------------
\section{Prototípus}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/sensor-proto.png}
	\caption{A környezeti szenzor elkészült prototípusa} 
\end{figure}

A prototípus elkészítésénél a legnagyobb problémát kis lábtávolságú elemek, és a chip alatt lévõ érintkezõk jelentették. A megoldást a forraszpaszta és hõlégfúvó jelentette, lényegében imitálva az újraömlesztéses forrasztást. A levegõ hõmérsékletének megválasztásakor figyelembe vettem az adatlapokon megadott ajánlott hõprofilt. Megoldandó továbbá az a probléma is, hogy mikrokontroller által termelt hõ befolyásolja a mért hõmérsékletet. Az adó/vevõ hatótávolsága jónak mondható, több szobára a modemtõl is erõs jelet ad.

%----------------------------------------------------------------------------
\subsection{Felmerült problémák}
%----------------------------------------------------------------------------

Sajnos a melegedés hatása nagyobbnak bizonyult, mint amire elõzetesen számítottam, egy kültéri mérés folyamán a referenciahõmérõnél 3.5 C\textdegree-al többet mutatott. Ha abból indulok ki, hogy a termelt hõmennyiség nagyjából konstans, a hõleadás pedig egyenesen arányos a hõkülönbséggel, akkor egy konstanssal való kompenzálás viszonylag jó megoldásnak t\H{u}nik. Ezen kívül a szenzornál szellõzést biztosító borítással, hõszigeteléssel, esetleg a mikrokontrolleren h\H{u}tõelem alkalmazással lenne javítható a pontosság.

A két fényérzékelõ szenzor címütközése miatt (engedélyezõ jel sincs), ezért egy idõben csak az egyik lehet beforrasztva. Mivel a VEML6040 (RGBW) által gy\H{u}jtött adatok jóval hasznosabbak, a prototípus ezzel készült el.