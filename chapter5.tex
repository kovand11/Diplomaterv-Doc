%Status: unchecked
%Todo: 
%----------------------------------------------------------------------------
\chapter{Nyitásérzékelõ}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/opendetector-setup.png}
	\caption{Az nyitásérzékelõ áramkör tipikus felhasználása} 
\end{figure}

Az ajtók és egyéb nyílászárók állapotának figyelése hasznos lehet épületbiztonsági és kényelmi funkciók megvalósításához. 

%----------------------------------------------------------------------------
\section{Specifikáció}
%----------------------------------------------------------------------------

Ezen egység célja hogy egy mágnes közelségét detektálni tudja (Reed kapcsolóval), és bármely érzékelt változást WiFi-n keresztül továbbítsa.
Ennék a modulnál a legnagyobb kihívást az energiagazdálkodás jelenti. A maximális üzemidõt elérendõ, azalatt az idõ alatt, amikor a kapcsoló állapota
nem változik, a központi mikrokontroller mélyalvásban tartózkodik, amibõl csak a állapotváltozásra létrejövõ reset impulzus hatására ébred fel.
Ekkor a modul felcsatlakozik a beállított hálózatra, és értesíti a központi egységet a saját állapotáról.

Az berendezés 31mm x 50mm-es helyen kívül, semmiféle huzalozást illetve áramforrás jelenlétét nem igényli. Egy töltéssel akár egy évig is képes lehet m\H{u}ködni.


%----------------------------------------------------------------------------
\section{Hardver}
%----------------------------------------------------------------------------


\begin{table}[ht]
	\footnotesize
	\centering
	\caption{A környezeti szenzor alkatrész listája}
	\begin{tabular}{|c|c|c|c|c|c|}
		\hline
		& \textbf{Db.} 	& \textbf{Leírás} 	& \textbf{Felh.} 	& \textbf{Gyártó} 	& \textbf{Azonosító} \\ 
		\hline
		1 & 1 & WiFi-s mikrokontroller & U1 & Espressif & ESP8285 \\
		\hline
		2 & 1 & Rezonátor kristály & U2 & Epson & FA-128 26Mhz \\
		\hline
		3 & 1 & Feszültség szabályzó & U4 & Microchip & MIC5353 \\
		\hline
		4 & 1 & Reed kapcsoló & U4 & Hamlin & MACD-14-20-25 \\
		\hline
		5 & 1 & XOR kapu (2) & U4 & TI & SN74LVC2G86DCTR \\
		\hline    
		6 & 1 & Header & P1 & Omron & XG8V-0831 \\ 
		\hline 
		7 & 1 & Akku csatlakozó & J1 & Adafruit  & JST-PH 2-pin \\
		\hline 		
		8 & 1 & Nyomógomb & SW1 & Omron & PTS810 \\
		\hline
		9 & 1 & LED (0603) & D1 & Panasonic & LNJxxx \\
		\hline
		10 & 14 & Ellenállás (0603) & R1..14 & Viking Tech Corp. & - \\
		\hline
		11 & 9 & Kondenzátor (0603) & C1..9 & Yageo, Samsung & - \\
		\hline
	\end{tabular} 
\end{table}

%----------------------------------------------------------------------------
\subsection{Tápellátás}
%----------------------------------------------------------------------------
\label{sec:li-ion-supp}

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/mic5353-block-diagram.png}
	\caption{MIC5353 blokkdiagramja} 
\end{figure}


\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/enviromental-sensor_power-supply.png}
	\caption{A nyitásérzékelõ szenzor tápáramköre} 
\end{figure}

Az egység tápellátására egy Microchip MIC5353 \cite{mic5353-ds} LDO (Low Dropout Voltage) regulátort használok, ami kifejezetten hordozható elektronikákhoz lett kifejlesztve. Kimeneti zaja rendkívül alacsony (30$\mu Vrms$), nyugalmi árama 90$\mu A$ és 100mA-es áramfelvételnél a kiesési feszültség (dropout voltage) mindössze 35mV, lehetõvé téve a Li-ion akkumulátor maximális kihasználását. A teljes hatásfok így 90\% felett van, ami lényegében megegyezik egy kapcsolóüzem\H{u} megoldáséval, annak minden hátránya nélkül (kimenet hullámossága, kiegészítõ áramkör). Az 1.6mm x 1.6mm-es thermalpad-es chip h\H{u}tést nem igényel.

Az akkumulátor egy JST-PH2 csatlakozóba (Adafruit saját szabvány) dugható be. A Li-ion védõáramköre integrálva van akkumulátorba, illetve a töltéshez vásárolt céláramkört használok.

Az akkumulátor merülési karakterisztikáját egy 3.7 V és 3.5 V közötti lináris csökkenéssel becsülve, elhanyagolva a teljes töltöttségnél elõforduló alacsonyabb és a közel kimerült állapotban szolgáltatott alacsonyabb feszültséget (mivel hatásuk nem jelentõs, és ráadásul ellentétes is), a hatásfok: $\frac{3.3}{\frac{3.7 + 3.5}{2}}=91.67\%$

Készenléti állapotban a domináns fogyasztók által felvett áram, 
$$I_{tot} = I_{MCU} + I_{XOR} + I_{R8} = 10\mu A + \frac{3.3V}{47k\Omega} + 10 \mu A = 90.21\mu A  $$
amit a az akkumulátor $T_1 = \frac{1200 mAh}{I_{tot}} = 13302 h$ hosszan tud ellátni, ami 554 napnak felel meg. Az üzemidõ a valóságban ennél rövidebb lesz. Egy állapotváltozás elküldése hozzávetõlegesen 200 mA*s felvételt jelent. 
Napi 20 nyitás/csukás-t feltételezve naponta, az üzemidõ $T_2 = \frac{1200 mAh}{I_{tot} + 20*\frac{200mAs}{24 h}} = 7891 h$ ami 366 napot jelent.

%----------------------------------------------------------------------------
\subsection{Nyitásdetektálás}
%----------------------------------------------------------------------------

A teljes berendezés áll az áramkörbõl, és egy állandó mágnesbõl. Az eszköz mindösszesen annyit csinál, hogy az mágnes meglétét figyeli, 
a felhasznált Reed kapcsoló a mágnes közelségére záródik (\ref{reset-logic}-as ábra). Elõzetesen ezen mechanikus megoldás helyett egy Hall szenzor alapú detektálást terveztem, de mivel a legtöbb ilyen eszköz 5 V-os meghajtást igényel, illetve az üresjárati fogyasztása is jelentõs, ezért ezt a megoldást elvetettem. 


%----------------------------------------------------------------------------
\subsection{Reset áramkör}
%----------------------------------------------------------------------------

Amikor a Reed kapcsolón nincs változás, a központi mikrokontroller mélyalvásban (lényegében kikapcsolt állapotban) tartózkodik, amibõl egy reset impulzussal ébreszthetõ fel. Ennek elõállítására egy két XOR kaput megvalósító áramkört használok. Az elsõ kapu negálja a kapcsolodó jelét. A negált jelbõl egy RC sz\H{u}rõ segítségével elõállítok egy (digitális értelemben) késleltetett jelet. A negált jellel történõ meghajtás további elõnye,
hogy a kondenzátor árama nem terheli a kapcsolóból (SW1) és a felhúzó ellenállásból (R8) álló bemeneti tagot, nagyobb ellenállás értéket téve lehetõvé.
Ezután a kívánt kimenet (negatív impulzus, ha változott a bemenet) elérhetõ a kapcsolóról levett, és a negált valamint eltolt jel XOR-olásával.
Az impulzus szélessége jó közelítéssel megegyezik a RC tag idõállandójával: $\tau=R*C=10k\Omega *1\mu F = 10ms$
Az IRST-t a mikrokontroller egy portjára kötve, annak konfigurálásával engedélyezhetõ (nagyimpedanciás állapot) és letiltható (logikai 1) a reset logika.


\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/opendetector-wakeup.png}
	\caption{A reset impulzust elõállító logika} 
	\label{reset-logic}
\end{figure}



%----------------------------------------------------------------------------
\section{Szofver}
%----------------------------------------------------------------------------

Mivel az eszköz üzemszer\H{u}en nincs bekapcsolva, így tetszõleges idõpontban nem is módosíthatóak a beállításai.
A m\H{u}ködéshez szükséges információk a következõek:

\begin{itemize}  
	\item a WiFi hálózat neve (SSID)
	\item a jelszó
	\item az értesítendõ szerver IP címe
\end{itemize}

Ezek az adatok a mikrokontroller törölhetõ memóriájában kerülnek eltárolásra (EEPROM), maximum 64 byte-on, 0-val jelölve a bejegyzés végét.
A beállítások viszont csak akkor érhetõek el, ha a következõ feltételek valamelyike teljesül:

\begin{itemize}  
	\item a hálózatnév jelszó kettõs érvénytelen (5 másodpercig nem tud csatlakozni)
	\item a szerver nem válaszol
	\item a szerver válasza egy, a setup módba állításra fenntartott kód
\end{itemize}

Ha valamelyik feltétel teljesült, akkor a mikrokontroller egy saját WiFi hozzáférési pontot (access point) nyit,
amire felcsatlakozva elérhetõvé válik a beállításokat tartalmazó \H{u}rlap, aminek kitöltése és elküldése után az eszköz újraindul.

%----------------------------------------------------------------------------
\section{Prototípus}
%----------------------------------------------------------------------------

Az elsõként elkészült környezeti szenzor élesztése alatt szerzett tapasztalatok birtokában ezen prototípus elkészítése jóval egyszer\H{u}bbnek bizonyult. Megemlíthetõ, hogy a hõlégfúvó láthatóan károsította a nyomtatott áramkört, egy helyen a forrasztásgátló maszk is elt\H{u}nt. 

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/opendetector-proto.png}
	\caption{Az elkészült nyitásérzékelõ áramkör} 
\end{figure}

%----------------------------------------------------------------------------
\subsection{Felmerült problémák}
%----------------------------------------------------------------------------

Az ébresztõ áramkör által elõállított reset jel érvényre jutásának megakadályozására hivatott IRST jel az R10 ellenállás kiforrasztásával
deaktiválásra került, mivel a GPIO konfogurációja csak bootolás után jutott érvényre, és a tranziens megzavarta reset folyamatot.
Mivel a szerver felé történõ transzfer jellemzõen egy másodpercen belül lezajlik, a tervezett funkcionalitás elvesztése nem bizonyult lényegesnek.

A GPIO0 láb után épített ellenállásosztás hibásan m\H{u}ködött, mivel jelentõs áram folyt ki az osztóból a láb felé, alkalmanként nem a
szándékolt módban indult el a mikrokontroller. A környezeti szenzornál alkalmazott megoldás (ami ellenállás cserével és eltávolítással elérhetõ volt) tökéletesen m\H{u}ködött.




