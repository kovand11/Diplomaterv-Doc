%Status: 8 lorems
%Todo: bevezetõ, specifikáció szövegesítése, hardware bevezetõ, weblap (root)

%----------------------------------------------------------------------------
\chapter{Programozható aljzat árammérõvel}
%----------------------------------------------------------------------------

%----------------------------------------------------------------------------
\section{Specifikáció}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\begin{minipage}{0.45\textwidth}
		\centering
		\includegraphics[width=0.9\textwidth]{figures/socket-energie-metering.jpg} % first figure itself
		\caption{Aljzat teljesítményméréssel}
		\label{fig:existing-socket-powermeter}
	\end{minipage}\hfill
	\begin{minipage}{0.45\textwidth}
		\centering
		\includegraphics[width=0.9\textwidth]{figures/socket-w-wifi.png} % second figure itself
		\caption{WiFi-s konnektor}
		\label{fig:existing-socket-wifi}
	\end{minipage}
\end{figure}

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/wifisocket-blocks.png}
	\caption{A programozható aljzat blokkdiagramja}
	\label{fig:wifisocket-blockdiagram} 
\end{figure}




A piacon rengeteg kapcsolható és teljesítménymérõs aljzat és hosszabító található meg (\ref{fig:existing-socket-powermeter}, \ref{fig:existing-socket-wifi}-es ábrák). Lehetséges, hogy létezik, de nekem nem sikerült olyat találnom ami:

\begin{itemize}  
	\item megfizethetõ (30\$-40\$)
	\item képes a hálózati feszültséget ki és bekapcsolni, tetszõleges logika alapján
	\item teljesítményt mér nagy pontossággal (beleértve a teljesítménytényezõt)
\end{itemize}

Egy programozható aljzat segítségével nem okos eszközök is okossá alakíthatóak (ki és bekapcsolhatóság erejéig). Az eszközömnél az egy kimenet\H{u} moduláris hosszabító kialakítás mellett döntöttem (\ref{fig:wifisocket-blockdiagram}-as ábra). 


%----------------------------------------------------------------------------
\section{Hardver}
%----------------------------------------------------------------------------

\begin{table}[ht]
	\footnotesize
	\centering
	\caption{A környezeti szenzor alkatrész listája}
	\begin{tabular}{|c|c|c|c|c|c|}
		\hline
		& \textbf{Db.} 	& \textbf{Leírás} 	& \textbf{Felh.} 	& \textbf{Gyártó} 	& \textbf{Azonosító} \\ 
		\hline
		1 & 1 & WiFi-s mikrokontroller & U1 & Espressif & ESP8285 \\
		\hline
		2 & 1 & Rezonátor kristály & U2 & Epson & FA-128 26Mhz \\
		\hline		
		3 & 1 & Nyomógomb & SW1 & CandK Components & D6C90 F2 LFS \\
		\hline
		4 & 3 & LED (0603) & D1..3 & Panasonic & LNJxxx \\
		\hline
		5 & 3 & Olvadóbiztosíték & F1,F2 & Shurter & 3403.0173.11 \\
		\hline
		6 & 1 & Relé & SW1 & TE Connectivity & RTE24005 \\
		\hline
		7 & 1 & Tranzisztor & Q1 & ON Semiconductor & MMBT2222ALT1G \\
		\hline
		8 & 1 & Egyenirányító & D4 & Rectron & FM4007W-W \\
		\hline
		9 & 1 & Tépegység 230AC->5V & x & Vigortronix & VTX-214-003-105 \\
		\hline
		10 & 1 & Buck 5V->3.3V & U4 & TI & LM3670MF-3.3 \\
		\hline
		11 & 1 & Header & P1 & Omron & XG8V-0831 \\ 
		\hline
		12 & 1 & Teljesítmény mérõ IC & U3 & ST & STPM10BTR \\
		\hline
		13 & 1 & Rezonátor kristály & Y1 & Abracon & ABLS-4.194304MHZ \\
		\hline
		14 & 1 & Árammérõ sönt & R25 & Wishay & WSLP5931 \\
		\hline
		15 & 1 & AC Csatlakozó & P1 & Qualtek & 703W-00/54 \\
		\hline
		16 & 1 & AC Foglalat & P2 & x  & x \\
		\hline
		17 & 26 & Ellenállás (0603) & R1..26 & Viking Tech Corp. & - \\
		\hline
		18 & 19 & Kondenzátor (0603) & C1..19 & Yageo, Samsung & - \\
		\hline

	\end{tabular} 
\end{table}

%----------------------------------------------------------------------------
\subsection{Tápellátás}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/wifisocket-power-supply.png}
	\caption{A tápáramkör} 
\end{figure}

Ez az egység a m\H{u}ködéséhez szükséges energiát 230V-os hálózatból veszi fel. A teljesítménymérõ chip és a WiFi-s mikrokontroller 3.3V is tápellátást kap, mig a relé meghajtásához 5V-ra van szükség.

%----------------------------------------------------------------------------
\subsubsection{Vigortronix VTX-214-003-105 \cite{vtx-214-003-105-ds}}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/vigortronix-block.png}
	\caption{Az VTX-214-003-105 blokkvázlata}
	\label{fig:vtx-214-003-105-block}
\end{figure}

A Vigortronix VTX konvertersorozatáról sajnos korlátozott részletesség\H{u} dokumentáció áll rendelkezésre. A tápegység teljesen leválasztott, integrált, a \ref{fig:vtx-214-003-105-block}-es ábrán látható, hogy semmiféle kiegészítõ áramkört nem igényel. Topológiáját tekintve leválasztott kapcsolóüzem\H{u} tápegység. A legfontosabb jellemzõi:

\begin{itemize}  
	\item 5V egyenfeszültség a kimeneten
	\item 600mA kimeneti áram
	\item 100 VAC-tól 275VAC-ig terjedõ bemeneti feszültség
	\item 47Hz - 63Hz bemeneti frekvencia
	\item alacsony hullámosság és zaj
	\item 4200Vrms - es izolácó
	\item Hiccup mehanizmus (rövid idõre leáll) túlterhelés esetén
	\item 70\% feletti hatásfok
	\item 30g-os súly	
\end{itemize}




%----------------------------------------------------------------------------
\subsubsection{Texas Instruments LM3670MF-3.3 \cite{lm3670mf-ds}}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/lm3670-func-block.png}
	\caption{Az LM3670MF funkcionális blokkdiagramja}
\end{figure}

A Texas Instruments LM3670 sorozata egy DC-DC szinkron step-down (buck) konverter, elsõsorban mobil eszközökre optimalizálva. A kimenetét (esetemben 3.3V) 5.5V és 3.3V között képes tartani (low dropout mode). A konverter extrém magas, hozzávetõlegesen 95\%-os hatásfokot nyújt. Az tipikus terhelés melletti 1MHz-es kapcsolási frekvencia miatt elegendõ három (két kondezátor és egy induktivitás) apró felületszerelt elem a chip m\H{u}ködtetéséhez. Annak érdekében, hogy alacsony áram mellett se csökkenjen a hatásfok, az vezérlés PWM-rõl (Pulse Width Modulation) PFM-re (Pulse Frequency Modulation) vált.

%----------------------------------------------------------------------------
\subsection{Teljesítménymérés}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/wifisocket-power-meter.png}
	\caption{Az teljesítménymérésért felelõs áramkörrészlet} 
\end{figure}

A teljesítményméréshez szükséges a feszültség és az áram folyamatos mintavételezése, mivel nem garantálható a tiszta ohmos terhelés. A jellemzõk mérésére akár használható általános célú mikrokontroller is, de valószínüsíthetõ, hogy komolyabb jelkondicionálás és elõerõsítés nélkül a pontosság még az 1\%-ot sem éri el. Mivel az általam használt mikrokontroller amúgy sem volt alkalmas a feladatra, ezért az ST STPM10BTR IC-jét vettem igénybe a teljesítményméréshez.

%----------------------------------------------------------------------------
\subsubsection{ST STPM10BTR \cite{stpm10-ds}}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/stpm10-block.png}
	\caption{Az STPM10BTR blokkvázlata} 
\end{figure}

Az ST STPM10BTR egy programozható, egyfázisú teljesítménymérõ IC. Képes hatásos, meddõ és látszólagos teljesítmény mérésére. Az hatásos teljesítményt két részre osztja:

\begin{itemize}
	\item 0. típus: csak az alapharmónikus által felvett teljesítmény
	\item 1. típus: a felharmónikusok által felvett teljesítmény 
\end{itemize}

Az áramnak és a feszültségnek elérhetõ a pillanatnyi és a négyzetes középértéke, valamint mérésre kerül a hálózati frekvencia is. 

A feszültségméréshez a hálózati feszültség sz\H{u}rt és leosztott változatát kell bevezetni az IC-be, figyelembe véve, hogy a bemenet 0.3V-ig toleráns. A kívánt osztás eléréséhez precíziós ellenállásokat használtam. Természetesen az állandó hiba kalibrációval kompenzálható. 

Az árammérés két bemeneten, négy féle konfigurációban történhet, két bemenet esetén elérhetõ a két áramban fellépõ különbség detektálása (tamper detection):

\begin{itemize}
	\item egy söntellenállás
	\item egy áramváltó
	\item egy áramváltó és egy sönt
	\item két áramváltó
\end{itemize}

Én az egy söntellenállásos (0.3m$\Omega$) megoldást választottam, mivel annak volt a legkisebb a helyigénye és a tamper detection funkciót nem igényeltem.

%----------------------------------------------------------------------------
\subsubsection{Az ,,SPI'' kommunikáció \cite{stpm10-spi}}
%----------------------------------------------------------------------------

A teljesítménymérõ IC-vel való kommunikáció egy speciális SPI-hoz hasonló protokollon keresztült történik:

\begin{itemize}
	\item  \textbf{SCS} engedélyezõ jel (0 aktív)
	\item  \textbf{SYN} a kommunikáció iránya (0 olvasás)
	\item  \textbf{SCL} az órajel
	\item  \textbf{SDC} az adatvezeték (kétirányú)
\end{itemize}

Az írást érdemes szoftveresen (GPIO-k állításával) implementálni, még akkor is ha ez lassabb, mivel futásidõben ezen m\H{u}velet ritka, szinte kizárólag csak olvasás történk.

Az olvasás a jelvezetékek ügyes bekötésével már történhet hardveres klasszikus 4 vezetékes SPI-al (MISO, MOSI, SCLK, SS). A MISO kerül az SDA vonalra, mivel ekkor a master fele törénik adatáramlás. Az órajelvezeték is összeköthetõ (SCLK->SCL). A slave select (SS) jel ráköthetõ a slave engedélyezõ jelére (SCS). A SYN jel (konstans 0) elõállítható egy GPIO-val, míg a MOSI jel nem kerül bekötésre.

%----------------------------------------------------------------------------
\subsection{A kapcsolórelé}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/wifisocket-relay.png}
	\caption{A relét kapcsoló áramkör}
	\label{fig:wifisocket-relay} 
\end{figure}

A hálózati áram kapcsolására egy Schrack RTE24005 DPDT (két pólus, két áramkör) relé került felhasználásra (\ref{fig:wifisocket-relay}-es ábra). A két kapcsolt áramkör a null és a fázis, a két pólus közül az egyik a hálózatra kapcsolódik, a másik a levegõben lóg. A relé 250VAC-ra és 8A-es terhelésre van méretezve. A belsõ tekercs aktiválásához szükséges 5V-ot egy bipoláris tranzisztorral kapcsolom, mivel a relé áramfelvétele 80mA, viszont a mikrokontroller csak 12mA-ig terhelhetõ.
A kikapcsoláskor a tekercsen maradt áram elvezetésérõl flyback dióda gondoskodik.  

%----------------------------------------------------------------------------
\section{Szofver}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, height=150mm, keepaspectratio]{figures/wifisocket-webpage.png}
	\caption{A programozható aljzat fõoldala}
	\label{fig:wifisocket-webpage}
\end{figure}

%----------------------------------------------------------------------------
\section{Paraméteres interface}
%----------------------------------------------------------------------------

\label{sec:parameters}

A hálózatba kapcsolt eszközök programozhatóságát nagy mértékben megkönnyíti, ha azok kívülrõl nézve bizonyos szempontból egységesek. Az absztrakció lehet egy, az eszközhöz hozzárendelt paraméterek halmaza, amelyek olvashatóak és esetenként írhatóak is. Például a pillanatnyi teljesítményt a power változó tartalmazza, ami csupán olvasható. Az hogy egy paraméter kívülrõl változónak t\H{u}nik, nem jelenti feltétlenül azt, hogy az az eszközön belül mindíg elérhetõ, lehet az egy lekérdezés által megindított folyamat (legtöbb esetben mérés) eredménye is. Azon funkciók amik beavatkoznak a környezetbe, írható változókként reprezentálhatóak.
A relé állása a relay változóba írt 0 vagy 1 értékkel állítható. Innentõl kezdve a teljes rendszer a szolgáltatott paraméterek, mint változók manipulálásával programozhatóak.
Ez a protokol, bár meglehetõsen rugalmas, az összes perifériát szolga (slave) szerepbe kényszeríti, mivel minden tranzakciót (írást/olvasást) a központi egység kezdeményez. Ha valamelyik periférián lenyomott gombhoz akarok akciót rendelni, akkor ezt csak úgy tehetem meg ha a hozzárendelt változót a másik eszközrõl pollolom, ami valamekkora idõveszteséggel jár.

A kiolvasás az WiFi-s eszköz által biztosított JSON (JavaScript Object Notation) interface-en keresztül történik. A JSON egy ember által is olvasható szöveges leírószabvány, ami az XML mellet a web legelterjedtebb formátuma. Az én implementációmban csak az összes változó egyidej\H{u} lekérdezésére van lehetõség, de a visszafele kompatibilitást megtartva hozzá lehetne adni a protokolhoz a változókra történõ sz\H{u}rés lehetõségét. A szenzor által biztosított JSON oldal:

\begin{lstlisting}
{
	"relay": "0",
	"led": "1",
	"power": "0.00",
	"voltage": "0.00",
	"current": "0.00",
	"powerfactor": "0.00"
} 
\end{lstlisting}

A paraméterek írásához a HTTP (Hypertext Transfer Protocol) GET vagy POST metódusa használható a /control oldalnak átadva. A GET paraméterek címsorba kódolhatóak: 
\begin{lstlisting}
http://192.168.0.20/control?relay=1&led=0
\end{lstlisting}

A változtatások érvényre jutását az eszköz a ,,Done'' üzenettel jelzi. Abban az esetban, ha bármi hiba merül fel az eszközzel kapcsolatban, nagyobb annak a valószín\H{u}sége, hogy válaszolni se tud az üzenetre.

\begin{table}[ht]
	\footnotesize
	\centering
	\caption{A Programozható aljzat paraméterei}
	\begin{tabular}{|l|l|l|l|}
		\hline
		\textbf{Név} & \textbf{Hozzáférés} 	& \textbf{Típus} & \textbf{Leírás}  \\ 
		\hline
		relay & írható/olvasható & boolean & a relé állapota \\
 		\hline
 		led & írható/olvasható & boolean & led állapota \\
 		\hline
 		power & olvasható & float & teljesítmény (W) \\
 		\hline
 		voltage & olvasható & float & feszültség (V) \\
 		\hline
 		current & olvasható & float & áram (A)\\
 		\hline
 		powerfactor & olvasható & float & teljesítmény tényezõ \\
 		\hline		
	\end{tabular} 
\end{table}


%----------------------------------------------------------------------------
\section{HTML oldal}
%----------------------------------------------------------------------------

A közvetlenül ember számára is használható fõoldal kialakításánal az AJAX (Asynchronous JavaScript and XML) technikát alkalmaztam. A módszertan lényege, hogy a weboldal újratöltése nélkül, az oldal tartalma változik dinamikusan. Az adatok fogadása és küldése asszinkron módon, a szerver (mikrokontroller) fele történõ folyamatos kommunikációval valósul meg, kihasználva a DOM (Document Object Model) nyújtotta funkciókat. (\ref{fig:wifisocket-webpage}-es ábra)

\lstinputlisting[language=HTML]{source/wifisocketMain.txt}

A onSwitch() függvény felelõs a felhasználó által megnyomott kapcsoló állapotának jelzése az eszköz felé. Az refreshData() függvény az eszköz állapotának változása alapján frissíti az weboldalt. Ez elõbbi a /control az utóbbi a /json aloldal szolgáltatásait használja. 
%----------------------------------------------------------------------------
\section{Prototípus}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\includegraphics[width=150mm, keepaspectratio]{figures/wifisocket-proto.png}
	\caption{A programozhtó aljzat prototípusa} 
\end{figure}

Az eszköz élesztése és tesztelése, mivel hálózati feszültségrõl m\H{u}ködik, kiemelt figyelmet és óvatosságot igényelt. A nagyfeszültség\H{u} vezetékekre nem került forrasztásgátló maszk, így lehetõség volt azok ónnal történõ megvastagítására. Ez garantálta, hogy zárlat esetén az olvadóbiztosíték aktiválódjon, én ne az áramkör égjen el. A tervezésnél cél volt, hogy külsõ, 5V-os tápról is m\H{u}ködtethetõ legyen az aljzat, elõsegítve a felprogramozást és a tesztelést. 

%----------------------------------------------------------------------------
\subsection{Felmerült problémák}
%----------------------------------------------------------------------------

A prototípusomon a LM3670MF-3.3 (Buck converter) engedélyezõ jelét földre húztam táp helyett. A hiba könnyen javítható volt új huzalozás szikével történõ kialakításával.

Mivel a ESP8285 és STPM10BTR között kommunikációnál nincs se leválasztás se szintillesztés, ezért az eredeti tervekkel ellentétben, a teljesítménymérõ is 3.3V-ról került meghajtásra.

%----------------------------------------------------------------------------
\subsubsection{Zavarjelenség}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
	\centering
	\begin{minipage}{0.45\textwidth}
		\centering
		\includegraphics[width=0.9\textwidth]{figures/wifisocket-glitch1.png} % first figure itself
		\caption{first figure}
	\end{minipage}\hfill
	\begin{minipage}{0.45\textwidth}
		\centering
		\includegraphics[width=0.9\textwidth]{figures/wifisocket-glitch2.png} % second figure itself
		\caption{second figure}
	\end{minipage}
\end{figure}

Hálózatról történõ meghajtás során az eszköz, a relé zárásakor gyakran újraindult. Hasonló jelenség csapán a digitrális ág meghajtása során nem lépett fel, az áramkör megbízhatóan m\H{u}ködött. Az újraindulásnak két oka lehet: 

\begin{itemize}  
	\item Zavarjel jut a reset lábra, ami újraindítja a mikrokontrollert
	\item A táp átmenetileg az elõírt 3V alá esik
\end{itemize}

A hiba identifikálása érdekében két mérést végeztem el:

\textbf{1. Mérés:} Az eszközt leválasztó transzformátorra kötve, oszcilloszkópot kötöttem az 5V-os és a 3.3V-os tápágra. A triggeresemény az 5V-os táp jelentõs bezuhanása volt. Látható, hogy a mindkét tápszinten jelentõs zavar (hozzávetõlegesen 150ns-ig fennálló 50MHz-s csillapított oszcilláció) jelent meg. A 3.3V-os ág rövid idõre beesett 2V alá. Ilyen frekvenciánál természetesen számít, hogy az áramkör mely pontján történik a mérés, de feltételezhetõ, hogy ez a zavar mindenhol jelen van. Ráadásul mindkét feszültségszintet is több konzdenzátor sz\H{u}ri.
Az zavar még akkor sem csökkent érdemben, amikor egy extra sz\H{u}rõkondenzátort helyeztem az 5V-os ágra.



\textbf{2. Mérés:} Kizárandó azt a lehetõséget, hogy a Vigortronix tépegység nem képes kezelni a relé által jelentett terhelést, annak kapcsolóágát egy, az áramfelvétel szempontjából ekvivalens, ellenállással helyettesítettem. Ekkor a hiba megsz\H{u}nt, a tápjelen csak minimális zaj volt érzékelhetõ. 

A hibát tehát a nagyfeszültség\H{u} rész, illetve a digitális logika interakciója okozza. Ezen zavarok megjóslása szinte lehetetlen, gyakran külsõ eredet\H{u}ek, ezért helyes tervezéssel csupán a kockázatok csökkenthetõel, illetve a hatások mérsékelhetõek:
\begin{itemize}  
	\item A digitális részek lehetõ legtávolabb helyezése a nagyfeszültség\H{u} területektõl
	\item A digitális jelek galvanikus leválasztása
	\item Az integrált áramkörök és esetlegesen a huzalozás árnyákolása
	\item Nagy potenciálkülönbség\H{u} elemek a lehetõ legtávolabb történõ elhelyezése, vagy bevágás létrehozása az áramkörön
\end{itemize}

Sajnos az én esetemben az STPM10BTR nem függetleníthetõ a táptól, ráadásul a kétirányú SPI-szer\H{u} kommunikáció miatt az ESP8285 se. Ez a probléma csak a nyák újratervezésével lehetne javítható, emiatt teljesítménymérõ konfigurálása (kalibrálása) elmaradt, illetve a relé csak kisebb feszültséget tud biztonságosan kapcsolni.


